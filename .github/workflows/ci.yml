name: CI

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'DOC_PT.md'
      - 'DOC_EN.md'
      - 'coverage.out'
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Check Go formatting
        run: |
          files=$(gofmt -l .)
          if [ -n "$files" ]; then
            echo "The following files need gofmt:"
            echo "$files"
            exit 1
          fi
      - name: Run go vet
        run: go vet ./...

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Run unit tests
        run: go test ./...

  release:
    name: Release with GoReleaser
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Compute deploy tag
        id: compute_tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = `deploy-${process.env.GITHUB_SHA.substring(0, 7)}`;
            core.setOutput('tag', tag);
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tag}`,
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
              } else {
                throw error;
              }
            }
      - name: Configure git user
        if: steps.compute_tag.outputs.exists != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Create and push tag
        if: steps.compute_tag.outputs.exists != 'true'
        env:
          TAG_NAME: ${{ steps.compute_tag.outputs.tag }}
        run: |
          git tag -a "${TAG_NAME}" -m "Automated deploy tag for commit ${GITHUB_SHA}."
          git push origin "${TAG_NAME}"
      - name: Run GoReleaser
        if: steps.compute_tag.outputs.exists != 'true'
        uses: goreleaser/goreleaser-action@v5
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ steps.compute_tag.outputs.tag }}
          GOPROXY: https://proxy.golang.org,direct
          GOSUMDB: sum.golang.org
